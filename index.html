<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MetaMaps MVP</title>
    <style>
      html, body { height: 100%; margin: 0; padding: 0; }
      #filters, #address-search { display: flex; justify-content: space-around; padding: 10px; background: #fff; border-bottom: 1px solid #ccc; font-family: sans-serif; }
      #filters button, #address-search button { padding: 8px 12px; font-size: 14px; border: 1px solid #aaa; border-radius: 5px; background: #f8f8f8; cursor: pointer; }
      #filters button:hover, #address-search button:hover { background: #eaeaea; }
      #filters button.active-filter { background-color: #4285f4; color: white; border-color: #4285f4; }
      #map { height: 60%; width: 100%; }
      #places-list { height: 30%; overflow-y: auto; padding: 10px; font-family: sans-serif; }
      #redo-search { display: none; background: #fff; border: 1px solid #ccc; padding: 8px 12px; font-family: sans-serif; font-size: 14px; cursor: pointer; position: absolute; top: 60px; left: 50%; transform: translateX(-50%); z-index: 10; box-shadow: 0 2px 6px rgba(0,0,0,0.2); border-radius: 4px; }
      #address-search input { flex: 1; padding: 8px; font-size: 14px; }
    </style>
  </head>

  <body>
    <div id="address-search">
      <input type="text" id="address" placeholder="Enter an address..." />
      <button onclick="goToAddress()">Go</button>
    </div>

    <div id="filters">
      <button onclick="updatePlaces('all', this)">‚ú≠ All</button>
      <button onclick="updatePlaces('restaurant', this)">üçΩ Restaurants</button>
      <button onclick="updatePlaces('cafe', this)">‚òï Caf√©s</button>
      <button onclick="updatePlaces('park', this)">üå≥ Parks</button>
      <button onclick="updatePlaces('tourist attraction', this)">üì∏ Attractions</button>
    </div>

    <div id="map"></div>
    <div id="places-list"></div>
    <div id="redo-search" onclick="redoSearch()">üîÑ Redo Search in This Area</div>

    <script>
      let map;
      let markers = [];
      let currentPlaceType = 'all';
      let currentCenter;

      const ALL_KEYWORDS = [
        "restaurant", "cafe", "bar", "night club", "hotel", "park",
        "tourist attraction", "viewpoint", "beach", "shopping mall",
        "market", "museum", "stadium", "sports complex", "historic site",
        "landmark", "hiking trail", "natural feature", "recreation",
        "recreation center", "library"
      ];

      function updatePlaces(newType, button) {
        currentPlaceType = newType;
        if (!currentCenter) { currentCenter = map.getCenter(); }
        runPlaceSearch(currentCenter);

        document.querySelectorAll("#filters button").forEach(btn => btn.classList.remove("active-filter"));
        button.classList.add("active-filter");
      }

      function redoSearch() {
        currentCenter = map.getCenter();
        document.getElementById("redo-search").style.display = "none";
        runPlaceSearch(currentCenter);
      }

      function runPlaceSearch(userLocation) {
        markers.forEach(marker => marker.setMap(null));
        markers = [];

        const service = new google.maps.places.PlacesService(map);
        const promises = [];

        if (currentPlaceType === 'all') {
          ALL_KEYWORDS.forEach(keyword => {
            promises.push(new Promise((resolve) => {
              service.nearbySearch({
                location: userLocation,
                radius: 1500,
                keyword
              }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                  resolve(results);
                } else {
                  resolve([]);
                }
              });
            }));
          });

          Promise.all(promises).then(allResults => {
            const merged = allResults.flat();
            const seen = new Map();
            const unique = merged.filter(place => {
              if (seen.has(place.place_id)) return false;
              seen.set(place.place_id, true);
              return true;
            });
            displayPlaces(unique);
          });

        } else {
          service.nearbySearch({
            location: userLocation,
            radius: 1500,
            keyword: currentPlaceType
          }, (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              displayPlaces(results);
            } else {
              console.warn("No places found or bad status");
            }
          });
        }
      }

      function displayPlaces(results) {
        const listContainer = document.getElementById("places-list");
        listContainer.innerHTML = "";

        results.sort((a, b) => b.user_ratings_total - a.user_ratings_total)
               .slice(0, 5)
               .forEach(place => {
          const marker = new google.maps.Marker({
            map,
            position: place.geometry.location,
            title: place.name
          });

          markers.push(marker);

          const infoWindow = new google.maps.InfoWindow({
            content: `<strong>${place.name}</strong><br/>‚≠ê ${place.rating} (${place.user_ratings_total} reviews)`
          });

          marker.addListener("click", () => infoWindow.open(map, marker));

          const placeDiv = document.createElement("div");
          placeDiv.style.padding = "10px";
          placeDiv.style.borderBottom = "1px solid #ccc";
          placeDiv.innerHTML = `<strong>${place.name}</strong><br/>‚≠ê ${place.rating} (${place.user_ratings_total} reviews)`;
          listContainer.appendChild(placeDiv);
        });
      }

      function goToAddress() {
        const address = document.getElementById("address").value;
        if (!address) return;

        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address }, (results, status) => {
          if (status === "OK" && results[0]) {
            const location = results[0].geometry.location;
            map.setCenter(location);
            map.setZoom(14);
            currentCenter = { lat: location.lat(), lng: location.lng() };
            runPlaceSearch(currentCenter);
          } else {
            alert("Address not found.");
          }
        });
      }

      function initMap() {
        const defaultLocation = { lat: 37.7749, lng: -122.4194 };
        map = new google.maps.Map(document.getElementById("map"), { center: defaultLocation, zoom: 14 });
        currentCenter = defaultLocation;

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((position) => {
            currentCenter = { lat: position.coords.latitude, lng: position.coords.longitude };
            map.setCenter(currentCenter);
            runPlaceSearch(currentCenter);
          }, () => runPlaceSearch(defaultLocation));
        } else {
          runPlaceSearch(defaultLocation);
        }

        google.maps.event.addListener(map, "dragend", () => document.getElementById("redo-search").style.display = "block");
      }
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBIS76510vyTaZ7vHJnY42wcKtyyme_JTk&libraries=places&callback=initMap"></script>
  </body>
</html>